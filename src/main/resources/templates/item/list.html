<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경매 목록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"> <!-- Font Awesome 아이콘 추가 -->
    <link rel="stylesheet" href="/css/fragments/topbar.css">
    <link rel="stylesheet" href="/css/fragments/sidebar.css">
    <link rel="stylesheet" href="/css/fragments/header.css">
    <link rel="stylesheet" href="/css/item/item_list.css">
</head>
<body>
<div th:insert="~{'fragments/topbar' :: topbar}"></div>
<div th:insert="~{'fragments/header' :: header}"></div>
<div class="container-fluid d-flex">
    <div th:insert="~{'fragments/sidebar' :: sidebar}"></div>

    <!-- Main Content -->
    <div class="content-container flex-grow-1 p-4">

        <!-- 검색 및 정렬 -->
        <form action="/items/list" method="get" class="mb-4" id="searchForm">
            <input type="hidden" name="search" th:value="${search}">
            <div class="row align-items-center">
                <!-- 정렬 기준 -->
                <div class="col-md-6 d-flex align-items-center">

                    <select name="sortBy" class="form-select" id="sortBy">
                        <option value="title" th:selected="${sortBy == 'title'}">정렬기준</option>
                        <option value="startingBid" th:selected="${sortBy == 'startingBid'}">시작가</option>
                        <option value="buyNowPrice" th:selected="${sortBy == 'buyNowPrice'}">즉시구매가</option>
                        <option value="startTime" th:selected="${sortBy == 'startTime'}">시작시간</option>
                        <option value="endTime" th:selected="${sortBy == 'endTime'}">마감시간</option>
                    </select>
                </div>

                <!-- 정렬 방향 -->
                <div class="col-md-3 d-flex align-items-center">
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input" type="radio" name="direction" id="asc" value="asc"
                               th:checked="${direction == 'asc'}">
                        <label class="form-check-label" for="asc">오름차순</label>
                    </div>
                    <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input" type="radio" name="direction" id="desc" value="desc"
                               th:checked="${direction == 'desc'}">
                        <label class="form-check-label" for="desc">내림차순</label>
                    </div>
                </div>

                <!-- 경매 상태 -->
                <div class="col-md-3 d-flex align-items-center">

                    <select name="status" class="form-select" id="status" onchange="submitFilterForm()">
                        <option value="" th:selected="${status == null}">경매상태</option>
                        <option th:each="state : ${statuses}" th:value="${state}" th:text="${state}"
                                th:selected="${status == state}"></option>
                    </select>
                </div>
            </div>
        </form>

        <!-- 카드 컨테이너 -->
        <div class="card-container">
            <a th:href="@{/items/detail/{id}(id=${item.itemId})}" class="card auction-card" th:each="item : ${items}" th:id="'item-card-' + ${item.itemId}"
               th:data-title="${item.title}"
               th:data-starting-bid="${item.startingBid}"
               th:data-status="${item.status}"
               th:data-buy-Now-Price="${item.buyNowPrice}"
               th:data-img-src="${item.fileUrl}">
                <img th:src="${item.fileUrl}" alt="상품 이미지" class="card-img-top">
                <div class="card-body">
                    <h5 class="card-title" th:text="${item.title}">상품 제목</h5>
                    <div class="card-text">
                        <p>
                            <strong>현재가:</strong>
                            <span th:text="${item.highestBid != null ? item.highestBid + ' 원' : item.startingBid + ' 원'}">현재가</span><br>
                            <strong>즉시 거래가:</strong>
                            <span th:text="${item.buyNowPrice != null ? item.buyNowPrice + ' 원' : '없음'}">즉시 거래가</span><br>
                            <strong>경매 종료일:</strong>
                            <span th:text="${item.endTime}">경매 종료일</span><br>
                            <strong>남은 시간:</strong>
                            <span th:text="${item.remainingTime}">남은 시간</span>
                        </p>
                        <!-- 장바구니 추가 버튼 -->
                        <button class="like-btn" onclick="addToCart(event)">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            </a>
        </div>

        <!-- 페이징 -->
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/items/list(page=${currentPage - 1}, size=${size}, sortBy=${sortBy}, direction=${direction}, search=${search}, status=${status})}">이전</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/items/list(page=${i}, size=${size}, sortBy=${sortBy}, direction=${direction}, search=${search}, status=${status})}"
                       th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/items/list(page=${currentPage + 1}, size=${size}, sortBy=${sortBy}, direction=${direction}, search=${search}, status=${status})}">다음</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const sortBy = document.getElementById("sortBy");
        const directionRadios = document.querySelectorAll("input[name='direction']");
        const statusSelect = document.getElementById("status");

        // 정렬 기준 변경 시
        sortBy.addEventListener("change", function () {
            document.getElementById("searchForm").submit();
        });

        // 정렬 방향 변경 시
        directionRadios.forEach(radio => {
            radio.addEventListener("change", function () {
                document.getElementById("searchForm").submit();
            });
        });

        // 상태 변경 시
        statusSelect.addEventListener("change", function () {
            document.getElementById("searchForm").submit();
        });
    });
    async function addToCart(event) {
        // 기본 동작 방지 (아이템 상세 페이지로 이동하지 않도록)
        event.preventDefault();

        // itemId는 버튼의 부모 요소 (card)에 대한 속성이나 다른 방법으로 추출할 수 있음
        const itemId = event.target.closest('.auction-card').id.split('-')[2];  // `item-card-${itemId}`에서 itemId 추출
        console.log(itemId);
        try {
            // 현재 유저 정보 가져오기
            const response = await fetch('/api/currentUser', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('현재 유저 정보를 가져오지 못했습니다.');
            }

            const currentUser = await response.json();
            const userId = currentUser.userId;  // 현재 유저 ID

            // 클릭한 아이템 정보 가져오기
            const item = document.querySelector(`#item-card-${itemId}`);
            const itemData = {
                itemId: itemId,
                title: item.dataset.title, // data-title 속성
                startingBid: item.dataset.startingBid,
                buyNowPrice: item.dataset.buyNowPrice,// data-starting-bid 속성
                status: item.dataset.status, // data-status 속성
                fileUrl: item.dataset.imgSrc
                // 필요한 아이템 정보 추가
            };

            // localStorage에 아이템을 저장 (유저 ID를 키로)
            let cart = JSON.parse(localStorage.getItem(userId)) || [];
            cart.push(itemData);
            localStorage.setItem(userId, JSON.stringify(cart));

            alert('아이템이 장바구니에 추가되었습니다!');
            console.log("Local Storage Data:", localStorage.getItem(userId));
        } catch (error) {
            console.error('장바구니 추가 중 오류 발생:', error);
            alert('장바구니에 추가하는 데 문제가 발생했습니다.');
        }
    }
</script>
</body>
</html>