<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/fragments/topbar.css">
    <link rel="stylesheet" href="/css/fragments/sidebar.css">
    <link rel="stylesheet" href="/css/fragments/header.css">
</head>

<body>
<div th:insert="~{'fragments/topbar' :: topbar}"></div>
<div th:insert="~{'fragments/header' :: header}"></div>
<div id="app" class="container-fluid p-0 d-flex">
    <!-- Sidebar -->
    <div th:insert="~{'fragments/sidebar' :: sidebar}"></div>

    <!-- Your Cart Section -->
    <div class="content-container flex-grow-1 p-4">
        <h2>Your Cart</h2>
        <div id="cartItems"></div>
    </div>
    <button onclick="clearCart()">Clear Cart</button>
</div>

<script>
    let currentUserId;

    document.addEventListener("DOMContentLoaded", () => {
        const userId = getCurrentUserId();
        syncWithServer(userId).then(() => loadCart(userId));
    });

    function getCurrentUserId() {
        fetch('/api/currentUser')
            .then((response) => {
                if (!response.ok) {
                    throw new Error('활성화된 세션이나 로그인된 유저가 없습니다.');
                }
                return response.json();
            })
            .then((user) => {
                currentUserId=user.userId;
            })
            .catch((err) => {
                console.error('세션 정보 에러:', err);
                alert('로그인 필요');
                window.location.href = '/login';
            });
        return currentUserId;
    }

    function loadCart(userId) {
        const cartItems = JSON.parse(localStorage.getItem(userId)) || [];
        const ul = document.getElementById("cartItems");
        ul.innerHTML = ""; // Clear the list before adding items

        cartItems.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = `${item.name} - $${item.price}`;
            ul.appendChild(li);
        });
    }

    function clearCart() {
        const userId = getCurrentUserId();
        localStorage.removeItem(userId);
        alert("Cart cleared!");
        document.getElementById("cartItems").innerHTML = "";
    }

    async function syncWithServer(userId) {
        try {
            // Fetch item list from the server
            const response = await fetch("/api/item-list"); // Replace with the actual API URL
            if (!response.ok) throw new Error("Failed to fetch item list from server.");
            const serverItems = await response.json();

            const localCart = JSON.parse(localStorage.getItem(userId)) || [];
            const localCartMap = new Map(localCart.map(item => [item.itemId, item]));

            serverItems.forEach((serverItem) => {
                if (localCartMap.has(serverItem.itemId)) {
                    // Update the existing item
                    localCartMap.set(serverItem.itemId, {
                        ...localCartMap.get(serverItem.itemId),
                        ...serverItem
                    });
                }
            });

            // Save updated cart back to localStorage
            const updatedCart = Array.from(localCartMap.values());
            localStorage.setItem(userId, JSON.stringify(updatedCart));

            console.log("Cart synced successfully with server.");
        } catch (error) {
            console.error("Error syncing with server:", error);
        }
    }
</script>
</body>
</html>
