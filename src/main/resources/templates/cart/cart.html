<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/fragments/topbar.css">
    <link rel="stylesheet" href="/css/fragments/sidebar.css">
    <link rel="stylesheet" href="/css/fragments/header.css">
</head>

<body>
<div th:insert="~{'fragments/topbar' :: topbar}"></div>
<div th:insert="~{'fragments/header' :: header}"></div>
<div id="app" class="container-fluid p-0 d-flex">
    <!-- Sidebar -->
    <div th:insert="~{'fragments/sidebar' :: sidebar}"></div>

    <!-- Your Cart Section -->
    <div class="content-container flex-grow-1 p-4">
        <h2>Your Cart</h2>
        <div id="cartItems"></div>
    </div>
    <button onclick="clearCart()">Clear Cart</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Initialize the database and sync with server on page load
        const request = indexedDB.open("shoppingDB", 1);

        request.onupgradeneeded = function(event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("cart")) {
                db.createObjectStore("cart", { keyPath: "itemId" });
            }
        };

        request.onsuccess = function(event) {
            const db = event.target.result;
            syncWithServer(db).then(() => loadCart(db));
        };

        request.onerror = function(event) {
            console.error("Failed to open IndexedDB:", event.target.error);
        };
    });

    function loadCart(db) {
        const transaction = db.transaction("cart", "readonly");
        const store = transaction.objectStore("cart");
        const request = store.getAll();

        request.onsuccess = function(event) {
            const cartItems = event.target.result;
            const ul = document.getElementById("cartItems");
            ul.innerHTML = ""; // Clear the list before adding items

            cartItems.forEach((item) => {
                const li = document.createElement("li");
                li.textContent = `${item.name} - $${item.price}`;
                ul.appendChild(li);
            });
        };

        request.onerror = function(e) {
            console.error("Error loading cart:", e.target.error);
        };
    }

    function clearCart() {
        const request = indexedDB.open("shoppingDB", 1);

        request.onsuccess = function(event) {
            const db = event.target.result;
            const transaction = db.transaction("cart", "readwrite");
            const store = transaction.objectStore("cart");

            store.clear().onsuccess = () => {
                alert("Cart cleared!");
                document.getElementById("cartItems").innerHTML = "";
            };
        };
    }

    async function syncWithServer(db) {
        try {
            // Fetch item list from the server
            const response = await fetch("/api/item-list"); // Replace with the actual API URL
            if (!response.ok) throw new Error("Failed to fetch item list from server.");
            const serverItems = await response.json();

            const transaction = db.transaction("cart", "readwrite");
            const store = transaction.objectStore("cart");

            const promises = serverItems.map((serverItem) =>
                new Promise((resolve, reject) => {
                    const getRequest = store.get(serverItem.itemId);

                    getRequest.onsuccess = function(e) {
                        const existingItem = e.target.result;
                        if (existingItem) {
                            // Update only if the item exists
                            const updatedItem = { ...existingItem, ...serverItem };
                            store.put(updatedItem).onsuccess = () => resolve();
                        } else {
                            resolve(); // Skip items that don't exist in IndexedDB
                        }
                    };

                    getRequest.onerror = (e) => reject(e.target.error);
                })
            );

            await Promise.all(promises); // Wait for all updates to complete
            console.log("Cart synced successfully with server.");
        } catch (error) {
            console.error("Error syncing with server:", error);
        }
    }
</script>
</body>
</html>
